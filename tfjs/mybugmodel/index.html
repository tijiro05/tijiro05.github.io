<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.0.0/dist/tf.min.js"></script>
  <title>昆虫識別 - TensorFlow.js</title>
  <style>
    body { font-family: sans-serif; }
  </style>
</head>
<body>
  <h1>虫を分類 - TensorFlow.js</h1>
  <img id="bug" src="kamemushi.jpg" width="100%" />
  <p id="result">分類中...</p>

  <script>
    const modelPath = 'model/model.json';

    tf.loadLayersModel(modelPath).then((model) => {
      const bugImage = document.getElementById('bug');

      bugImage.onload = () => {
        // 画像をテンソルに変換（量子化uint8モデル用）
        const tensor = tf.browser.fromPixels(bugImage)
          .resizeBilinear([224, 224])
          .toInt()  // ← 重要：量子化モデル用に整数型に
          .expandDims(); // shape: [1, 224, 224, 3]

        // 推論
        const prediction = model.predict(tensor);

        prediction.array().then((data) => {
          const scores = data[0]; // 例: [0.95, 0.05]
          const classIndex = scores.indexOf(Math.max(...scores));
          const classLabels = ['蚊', 'バッタ', 'てんとう虫', 'あぶら虫', 'カメムシ', '蟻', '蜂', '蝶々', 'トンボ', '蜘蛛', '未定義'];
          const resultText = `分類結果: ${classLabels[classIndex]}（信頼度: ${(scores[classIndex] * 100).toFixed(1)}%）`;
          document.getElementById('result').textContent = resultText;

          console.log('スコア:', scores);
        });
      };

      // 画像がすでに読み込まれていたらすぐ推論
      if (bugImage.complete) {
        bugImage.onload();
      }
    });
  </script>
</body>
</html>
